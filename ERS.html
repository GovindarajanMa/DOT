<!DOCTYPE html>
<html>
<head>
	<script src="js/jquery-vsdoc.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script type="text/javascript" src="https://code.jquery.com/jquery-1.7.1.min.js"></script>
	<script type="text/javascript" src="jquery.ajax-cross-origin.min.js"></script>
	<!--<script src="maps.googleapis.com/maps/api/js?v=3&sensor=false"></script>-->
	<!--<script src="js/google-maps-3-vs-1-0.js"></script>-->
	<title></title>
	<style>
		#map {
			height: 100%;
		}
		/* Optional: Makes the sample page fill the window. */
		html, body {
			height: 100%;
			margin: 0;
			padding: 0;
		}
	</style>
	<meta charset="utf-8" />
	<script>
		var geocoder;
		var map;
		var markers = [];
		//var jsonERSStr = '{ "tcJSON":{"LastUpdated":"08/03/2017 04:10 PM","data":[{"EventId":"145352","EventCreatedDate":"2017-11-05T20:28:55","EventStartDate":"11/05/2017","EventEndDate":"","LastUpdate":"2017-11-05T20:25:20","EventStatus":"Open","EventCategory":"Current Event","EventType":"Planned Roadway","EventSubType":"Construction activity/event","RoadwayName":"I-90","Direction":"Westbound","LocationType":"Point","PrimaryLatitude":"42.28077","PrimaryLongitude":"-71.51481","SecondaryLatitude":"NaN","SecondaryLongitude":"NaN","LocationDescription":"I-90 Westbound at Woodland Rd","LaneBlockageDescription":"Lane Affected: | | | | Lane Pattern: |L|L|L|","RecurrenceDescription":""},{"EventId":"145339","EventCreatedDate":"2017-11-05T20:28:55","EventStartDate":"11/05/2017","EventEndDate":"","LastUpdate":"2017-11-05T20:25:20","EventStatus":"Open","EventCategory":"Current Event","EventType":"Planned Roadway","EventSubType":"Other","RoadwayName":"I-95","Direction":"Northbound","LocationType":"Point","PrimaryLatitude":"42.78018","PrimaryLongitude":"-70.92611","SecondaryLatitude":"NaN","SecondaryLongitude":"NaN","LocationDescription":"I-95 Northbound at Exit (56) Scotland Rd","LaneBlockageDescription":"Lane Affected: | | | |X| Lane Pattern: |L|L|L|R|","RecurrenceDescription":""},{"EventId":"145390","EventCreatedDate":"2017-11-05T20:28:55","EventStartDate":"11/05/2017","EventEndDate":"","LastUpdate":"2017-11-05T20:25:20","EventStatus":"Open","EventCategory":"Planned Event","EventType":"Planned Roadway","EventSubType":"Other","RoadwayName":"RT-128","Direction":"Northbound","LocationType":"Linear","PrimaryLatitude":"42.52686","PrimaryLongitude":"-70.95671","SecondaryLatitude":"42.55802","SecondaryLongitude":"-70.92894","LocationDescription":"RT-128 Northbound Centennial Dr to High St","LaneBlockageDescription":"Lane Affected: |X| | Lane Pattern: |L|L|","RecurrenceDescription":"Tuesday 20:00 - 4:00"}]}}';
		//var jsonERS = JSON.parse(jsonERSStr);
		//var ers_markers = jsonERS["tcJSON"]["data"];
		//alert('ers_markers' + JSON.stringify(ers_markers));
		
		function initialize() {
			map = new google.maps.Map(
			document.getElementById("map"), {
				center: new google.maps.LatLng(42.42419226039928, -71.77683383067325),
				zoom: 8, minZoom: 7,
				maxZoom: 14,
				mapTypeId: google.maps.MapTypeId.ROADMAP,
				disableDefaultUI: true,
				fullscreen: false
			});
			
			// AJAX Converting Xml into Json

			$.ajax({
				crossOrigin: true,
				type: 'GET',
				url: 'http://208.253.11.187/xml/events.xml',
				dataType: ($.browser.msie) ? "text" : "xml",
				success: function (xmlDoc) {
					//alert("success");
					//alert(xmlDoc);
					//var processedXML = $.parseXml(xml);
					//alert(processedXML);
					//var jsonText = JSON.stringify(xmlToJson(xml));
					//alert(jsonText);
					//alert(xmlDoc);
					//var xml = xmlDoc.toString().split('\n').slice(2, -2).join('\n').trim();
					//alert("xml: " + xml);
					var oParser = new DOMParser();
					var xml = oParser.parseFromString(xmlDoc, "text/xml");
					// Changes XML to JSON
					function xmlToJson(xml) {

						// Create the return object
						var obj = {};

						if (xml.nodeType == 1) { // element
							// do attributes
							if (xml.attributes.length > 0) {
								//obj["attributes"] = {};
								for (var j = 0; j < xml.attributes.length; j++) {
									var attribute = xml.attributes.item(j);
									//obj["attributes"][attribute.nodeName] = attribute.nodeValue;
									obj['@' + attribute.nodeName] = attribute.nodeValue;
								}
							}
						} else if (xml.nodeType == 3) { // text
							obj = xml.nodeValue.trim(); // add trim here
						}

						// do children
						if (xml.hasChildNodes()) {
							for (var i = 0; i < xml.childNodes.length; i++) {
								var item = xml.childNodes.item(i);
								var nodeName = item.nodeName;
								// 	console.debug('child',nodeName,item)
								if (typeof (obj[nodeName]) == "undefined") {
									var tmp = xmlToJson(item);
									if (tmp !== "") // if not empty string
										obj[nodeName] = tmp;
								} else {
									if (typeof (obj[nodeName].push) == "undefined") {
										var old = obj[nodeName];
										obj[nodeName] = [];
										obj[nodeName].push(old);
									}
									var tmp = xmlToJson(item);
									if (tmp !== "") // if not empty string
										obj[nodeName].push(tmp);
								}
							}
						}
						if (!Array.isArray(obj) && typeof obj == 'object') {
							var keys = Object.keys(obj);
							if (keys.length == 1 && keys[0] == '#text') return obj['#text'];
							if (keys.length === 0) return null;
						}
						return obj;
					}

					var obj = xmlToJson(xml);
					console.clear();
					console.debug(obj);
					//document.getElementById('pre').innerHTML = JSON.stringify(obj, null, '  ');
					//var jsonERSStr2 = JSON.stringify(obj);
					//alert(jsonERSStr2);
					var options = JSON.parse(JSON.stringify(obj));  // Uncomment these lines for actual data
					var ers_markers = options["ERS_Events"]["Events"]["Event"];  // Uncomment these lines for actual data
					//alert('ers_markers' + JSON.stringify(ers_markers));

					// Only current incidents data
					//var jsonERSStr2 = '{"data":[{"EventId":"145352","EventCreatedDate":"2017-11-13T21:50:50","EventStartDate":"11/13/2017","EventEndDate":"","LastUpdate":"2017-11-13T21:47:27","EventStatus":"Open","EventCategory":"Current Event","EventType":"Planned Roadway","EventSubType":"Construction activity/event","RoadwayName":"I-90","Direction":"Westbound","LocationType":"Point","PrimaryLatitude":"42.28077","PrimaryLongitude":"-71.51481","SecondaryLatitude":"NaN","SecondaryLongitude":"NaN","LocationDescription":"I-90 Westbound  at Woodland Rd","LaneBlockageDescription":"Lane Affected: | | | |  Lane Pattern:  |L|L|L|","RecurrenceDescription":""},{"EventId":"144787","EventCreatedDate":"2017-10-20T10:58:32","EventStartDate":"10/20/2017","EventEndDate":"","LastUpdate":"2017-10-20T10:55:30","EventStatus":"Open","EventCategory":"Current Event","EventType":"Planned Roadway","EventSubType":"Road construction","RoadwayName":"RT-28","Direction":"Northbound","LocationType":"Point","PrimaryLatitude":"42.19344","PrimaryLongitude":"-71.06011","SecondaryLatitude":"NaN","SecondaryLongitude":"NaN","LocationDescription":"RT-28 Northbound  at Royal St","LaneBlockageDescription":"Lane Affected: | | |  Lane Pattern:  |L|L|","RecurrenceDescription":""},{"EventId":"145565","EventCreatedDate":"2017-11-27T11:13:29","EventStartDate":"11/27/2017","EventEndDate":"","LastUpdate":"2017-11-27T11:10:29","EventStatus":"Open","EventCategory":"Current Event","EventType":"Roadway/Traffic","EventSubType":"pothole","RoadwayName":"RT-38","Direction":"Northbound","LocationType":"Point","PrimaryLatitude":"42.54902","PrimaryLongitude":"-71.17526","SecondaryLatitude":"NaN","SecondaryLongitude":"NaN","LocationDescription":"RT-38 Northbound  at Middlesex Ave","LaneBlockageDescription":"Lane Affected: | | |  Lane Pattern:  |L|L|","RecurrenceDescription":""},{"EventId":"145568","EventCreatedDate":"2017-11-27T15:08:46","EventStartDate":"11/27/2017","EventEndDate":"","LastUpdate":"2017-11-27T15:05:46","EventStatus":"Open","EventCategory":"Current Event","EventType":"Roadway/Traffic","EventSubType":"Crash without injury","RoadwayName":"I-93","Direction":"Northbound","LocationType":"Point","PrimaryLatitude":"42.45937","PrimaryLongitude":"-71.10194","SecondaryLatitude":"NaN","SecondaryLongitude":"NaN","LocationDescription":"I-93 Northbound  at Exit (34) Rt-28/ Main Street","LaneBlockageDescription":"Lane Affected: | | | | |  Lane Pattern:  |L|L|L|L|","RecurrenceDescription":""}]}'
					// Working data
					var jsonERSStr2 = '{"data":[{"EventId":"145352","EventCreatedDate":"2017-11-13T21:50:50","EventStartDate":"11/13/2017","EventEndDate":"","LastUpdate":"2017-11-13T21:47:27","EventStatus":"Open","EventCategory":"Current Event","EventType":"Planned Roadway","EventSubType":"Construction activity/event","RoadwayName":"I-90","Direction":"Westbound","LocationType":"Point","PrimaryLatitude":"42.28077","PrimaryLongitude":"-71.51481","SecondaryLatitude":"NaN","SecondaryLongitude":"NaN","LocationDescription":"I-90 Westbound  at Woodland Rd","LaneBlockageDescription":"Lane Affected: | | | |  Lane Pattern:  |L|L|L|","RecurrenceDescription":""},{"EventId":"144787","EventCreatedDate":"2017-10-20T10:58:32","EventStartDate":"10/20/2017","EventEndDate":"","LastUpdate":"2017-10-20T10:55:30","EventStatus":"Open","EventCategory":"Current Event","EventType":"Planned Roadway","EventSubType":"Road construction","RoadwayName":"RT-28","Direction":"Northbound","LocationType":"Point","PrimaryLatitude":"42.19344","PrimaryLongitude":"-71.06011","SecondaryLatitude":"NaN","SecondaryLongitude":"NaN","LocationDescription":"RT-28 Northbound  at Royal St","LaneBlockageDescription":"Lane Affected: | | |  Lane Pattern:  |L|L|","RecurrenceDescription":""},{"EventId":"145565","EventCreatedDate":"2017-11-27T11:13:29","EventStartDate":"11/27/2017","EventEndDate":"","LastUpdate":"2017-11-27T11:10:29","EventStatus":"Open","EventCategory":"Current Event","EventType":"Roadway/Traffic","EventSubType":"pothole","RoadwayName":"RT-38","Direction":"Northbound","LocationType":"Point","PrimaryLatitude":"42.54902","PrimaryLongitude":"-71.17526","SecondaryLatitude":"NaN","SecondaryLongitude":"NaN","LocationDescription":"RT-38 Northbound  at Middlesex Ave","LaneBlockageDescription":"Lane Affected: | | |  Lane Pattern:  |L|L|","RecurrenceDescription":""},{"EventId":"144922","EventCreatedDate":"2017-10-26T10:27:30","EventStartDate":"11/01/2017","EventEndDate":"12/03/2017","LastUpdate":"2017-10-26T10:24:37","EventStatus":"Open","EventCategory":"Planned Event","EventType":"Planned Roadway","EventSubType":"Construction activity/event","RoadwayName":"I-95","Direction":"Northbound","LocationType":"Point","PrimaryLatitude":"42.59257","PrimaryLongitude":"-70.96146","SecondaryLatitude":"NaN","SecondaryLongitude":"NaN","LocationDescription":"I-95 Northbound  at Newbury St","LaneBlockageDescription":"Lane Affected: | |X| | | |X|  Lane Pattern:  |M|L|L|L|L|S|","RecurrenceDescription":""},{"EventId":"145414","EventCreatedDate":"2017-11-16T11:25:43","EventStartDate":"12/05/2017","EventEndDate":"12/05/2017","LastUpdate":"2017-11-21T16:57:57","EventStatus":"Open","EventCategory":"Planned Event","EventType":"Planned Roadway","EventSubType":"Bridge inspection","RoadwayName":"US-6","Direction":"Eastbound","LocationType":"Linear","PrimaryLatitude":"41.72769","PrimaryLongitude":"-71.16072","SecondaryLatitude":"41.71773","SecondaryLongitude":"-71.15488","LocationDescription":"US-6 Eastbound  0.10 mi. from beyond Brayton Ave to 0.20 mi. before Brownell St","LaneBlockageDescription":"Lane Affected: | |X|X|  Lane Pattern:  |L|L|S|","RecurrenceDescription":""},{"EventId":"145096","EventCreatedDate":"2017-11-01T13:20:51","EventStartDate":"12/07/2017","EventEndDate":"12/07/2017","LastUpdate":"2017-11-01T13:17:07","EventStatus":"Open","EventCategory":"Planned Event","EventType":"Planned Roadway","EventSubType":"Construction activity/event","RoadwayName":"US-3","Direction":"Northbound","LocationType":"Point","PrimaryLatitude":"42.47647","PrimaryLongitude":"-71.18308","SecondaryLatitude":"NaN","SecondaryLongitude":"NaN","LocationDescription":"US-3 Northbound  at Sylvanus Wood Ln","LaneBlockageDescription":"Lane Affected: | | |X|X|X|  Lane Pattern:  |M|L|L|L|S|","RecurrenceDescription":""}]}';
					//var options = JSON.parse(jsonERSStr2);  // Uncomment these lines for testing
					//var ers_markers = options["data"];   // Uncomment these lines for testing
					//alert('ers_markers' + JSON.stringify(ers_markers));
					var currWindow = false;
					var
					that = this, //used in internal methods
					$currentCheckbox = $(document.getElementById("viewCurrentEventsCheckbox"))
					.change(function () {
						if ($(this).prop("checked")) {
							//alert('current checkbox checked');
							$.each(ers_markers, function (i, value) {

								if (value["EventCategory"] == "Current Event") {
									var
									CurrentEventImg = 'http://www.massdot.state.ma.us//DesktopModules/MassDOT/MapPlugins/ERS/images/CurrentEvent.png';
									image = CurrentEventImg,
									myLatLng = new google.maps.LatLng(value.PrimaryLatitude, value.PrimaryLongitude),
									marker = new google.maps.Marker({
										position: myLatLng,
										title: value.RoadwayName + ((value.EventSubType.length > 0 && value.EventSubType != "Other") ? (" (" + value.EventSubType) + ")" : ""),
										clickable: true,
										map: map,
										icon: image,
										height: 24,//50,
										width: 24,//22,
										index: i,
										anchor: new google.maps.Point(12, 12)
									});
									marker.addListener('click', function () {
										//var content = getinfoWindowHtml(value);
										//infoWindow.setContent(content);
										//infowindow.open(map, marker);
										if (currWindow) {
											currWindow.close();
										}
										var contentString = getinfoWindowHtml(value);
										//alert(content);
										var infowindow = new google.maps.InfoWindow({
											content: contentString,
											maxWidth: 500,
											maxHeight: 240

										});
										currWindow = infowindow;
										infowindow.open(map, marker);
									});
									markers.push(marker);
								}
							});
							setMapOnAll(map);

						} else {
							//alert('current checkbox unchecked');
							//marker2.setVisible(false);
							//marker2.setMap(null);
							setMapOnAll(null);
							markers = [];
						}
					}),
					$plannedCheckbox = $(document.getElementById("viewPlannedEventsCheckbox"))
					.change(function () {
						if ($(this).prop("checked")) {
							//alert('planned checkbox checked');

							$.each(ers_markers, function (i, value) {
								if (value["EventCategory"] == "Planned Event") {
									var
									PlannedEventImg = 'http://www.massdot.state.ma.us//DesktopModules/MassDOT/MapPlugins/ERS/images/PlannedEvent.png';
									image = PlannedEventImg,
									myLatLng = new google.maps.LatLng(value.PrimaryLatitude, value.PrimaryLongitude),
									marker = new google.maps.Marker({
										position: myLatLng,
										title: value.RoadwayName + ((value.EventSubType.length > 0 && value.EventSubType != "Other") ? (" (" + value.EventSubType) + ")" : ""),
										clickable: true,
										map: map,
										icon: image,
										height: 24,//50,
										width: 24,//22,
										index: i,
										anchor: new google.maps.Point(12, 12)
									});
									//var infoWindow = map["infoWindow"];
									marker.addListener('click', function () {
										//var content = getinfoWindowHtml(value);
										//infoWindow.setContent(content);
										//infowindow.open(map, marker);
										if (currWindow) {
											currWindow.close();
										}
										var contentString = getinfoWindowHtml(value);
										//alert(content);
										var infowindow = new google.maps.InfoWindow({
											content: contentString,
											maxWidth: 500,
											maxHeight: 240

										});
										currWindow = infowindow;
										infowindow.open(map, marker);
									});
									markers.push(marker);
								}
							});
							setMapOnAll(map);
						}
						else {
							//alert('planned checkbox unchecked');
							//marker1.setVisible(false);
							//marker1.setMap(null);
							setMapOnAll(null);
							markers = [];
						}
					})

				}
			});

				function setMapOnAll(map) {
					for (var i = 0; i < markers.length; i++) {
						markers[i].setMap(map);
					}
				}

				function getinfoWindowHtml(smarker) {
					var newRowColor = "white";

					function addRow(colname, data) {
						if (data != null && data.length > 0) {
							var rowHTML = "<div style=\"width:300px\" class=\"clearfix\"><h5 style=\"vertical-align:top;margin:0;display:inline;float:left;color:black !important\">" + colname + "&nbsp;</h5><ul class=\"clearfix\" style=\"max-width:200px;vertical-align:top;margin:-1px 0 0 0;padding:0;display:inline;float:left;\"><li style=\"list-style-image:none !important;margin:0 !important;font-size:0;color:white\"><span style=\"line-height:18px;color:black;font-size:13px;\">" + data + "</span></li></ul></div>";
							newRowColor = newRowColor == "white" ? "whitesmoke" : "white";
							table += rowHTML;
						}
					}


					var isCurrent = (smarker["EventCategory"] == "Current Event");
					var startDate = smarker.EventStartDate;
					var endDate = smarker.EventEndDate;
					var days = smarker.RecurrenceDescription.replace(/\n/g, "<br/>");
					var location = smarker.LocationDescription;
					var header = "<h2 style=\"color:black !important;vertical-align:top;text-align:center;margin:0 0 10px 0\">&nbsp;";
					//header += smarker.EventType;
					header += isCurrent ? "Incident" : "Road&nbsp;Work";
					header += "&nbsp;</h2>";
					var eventType = (smarker.EventSubType.length > 0 && smarker.EventSubType != "Other") ? (smarker.EventSubType) : "";

					var table = "<div style=\"\" class=\"clearfix\">";
					table += header;
					addRow("Type:", eventType);
					if (isCurrent) {
						addRow("Date&nbsp;Reported:", startDate);
					}
					else {
						addRow("Start&nbsp;Date:", startDate);
						addRow("End&nbsp;Date:", endDate);
						addRow("Days/Times:", days);
					}
					addRow("Location:", location);
					return table + "</div>";
				}
		}
	</script>
	<script async defer
			src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDZdyvZrDV1xDwTBnm42JfikPWSJqmw_3o&callback=initialize">
	</script>
</head>
<body>
	<div id="viewRoadIncidentDiv" style="margin-right: 30px; float: left !important;">
		<label> <strong>Road&nbsp;Work&nbsp;&amp;&nbsp;Incidents</strong> </label>
		<div style="margin: 5px 0px 0px; width: 140px;">
			<div>
				<div style="margin-bottom: 5px;">
					<input id="viewPlannedEventsCheckbox" style="vertical-align: top; margin-left: 0px !important;" type="checkbox">
					<label style="width: 109px; vertical-align: middle;" for="viewPlannedEventsCheckbox">
						<img alt="Road Work" style="vertical-align: middle;" src="http://www.massdot.state.ma.us//DesktopModules/MassDOT/MapPlugins/ERS/images/PlannedEvent.png">&nbsp;&nbsp;Road&nbsp;Work
					</label>
				</div>
				<div style="width: 140px;">
					<input id="viewCurrentEventsCheckbox" style="vertical-align: top; margin-left: 0px !important;" type="checkbox">
					<label style="width: 109px; vertical-align: middle;" for="viewCurrentEventsCheckbox">
						<img alt="Incidents" style="vertical-align: middle;" src="http://www.massdot.state.ma.us//DesktopModules/MassDOT/MapPlugins/ERS/images/CurrentEvent.png">&nbsp;&nbsp;Incidents
					</label>
				</div>
			</div>
		</div>
	</div>
	<div id="map" style="width:100%;height:600px;"></div>
</body>
</html>
